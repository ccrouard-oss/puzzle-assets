<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Puzzle – 2D strict (déplacement fluide + aimantation robuste)</title>
  <style>
    html,body{
      height:100%;
      margin:0;
      background:#0d1117;
      color:#e6edf3;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    }

    /* === Correction : centrage du puzzle === */
    #app {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .hud {
      position: fixed;
      left: 12px;
      top: 12px;
      z-index: 5;
      background: rgba(0,0,0,.45);
      border: 1px solid rgba(255,255,255,.08);
      padding: 8px 10px;
      border-radius: 10px;
      backdrop-filter: blur(6px);
      font-size: 13px;
      line-height: 1.35;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,.1);
    }

    .btn {
      cursor: pointer;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: #e6edf3;
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 12px;
    }

    canvas {
      display: block;
      margin: auto;
      touch-action: none;
      max-width: 100%;
      max-height: 100%;
    }
  </style>

  <script type="importmap">
    { "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    } }
  </script>
</head>
<body>
  <div id="app"></div>

  <div class="hud">
    <div class="badge">Mode: 2D strict</div>
    <div class="badge" id="groupInfo">Bloc: 1 pièce</div>
    <div class="badge" id="placedInfo">0 placées</div>
    <label style="display:flex;gap:6px;align-items:center">
      <input type="checkbox" id="lockAfterMerge" checked /> Verrouiller blocs assemblés
    </label>
    <button class="btn" id="resetBtn">Réinitialiser</button>
  </div>

  <audio id="snapSound" src="click.wav" preload="auto"></audio>

  <script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    const MODEL_URL = 'puzzle_50_scattered.glb';
    const ROWS=5, COLS=10;
    const PUZZLE_W=3.0, PUZZLE_H=4.0;
    const CELL_W=PUZZLE_W/COLS, CELL_H=PUZZLE_H/ROWS;

    const POS_EPS = 0.003;
    const LERP_DRAG = 0.35;
    const LERP_SNAP = 0.5;
    const SNAP_GRID = 0.18;
    const SNAP_NEIGH_EAGER = 0.14;
    const SNAP_NEIGH = 0.2;
    const STICKY_BAND = 0.25;
    const MIN_CENTER_DIST = Math.min(CELL_W, CELL_H)*0.42;
    const BOUNDS_MARGIN = 0.6;

    const app = document.getElementById('app');
    const scene = new THREE.Scene(); scene.background = new THREE.Color('#0d1117');

    function makeOrtho(){
      const aspect = window.innerWidth / window.innerHeight;
      const viewH = PUZZLE_H * 1.15;
      const viewW = viewH * aspect;
      return new THREE.OrthographicCamera(-viewW/2, viewW/2, viewH/2, -viewH/2, -10, 10);
    }
    const camera = makeOrtho();
    camera.position.set(0,0,5); camera.lookAt(0,0,0);

    const renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setPixelRatio(Math.min(devicePixelRatio,2));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    app.appendChild(renderer.domElement);

    scene.add(new THREE.HemisphereLight(0xffffff,0x223344,0.8));
    const dl = new THREE.DirectionalLight(0xffffff,0.6); dl.position.set(2,3,4); scene.add(dl);

    const raycaster = new THREE.Raycaster();
    const pointer = new THREE.Vector2();

    const puzzleRoot = new THREE.Group(); scene.add(puzzleRoot);
    const pickableMeshes = [];
    const entriesByName = new Map();
    const entries = [];

    const x0 = -PUZZLE_W/2 + CELL_W/2;
    const y0 =  PUZZLE_H/2 - CELL_H/2;
    const targetOf = (rc)=> new THREE.Vector3(x0 + rc.c*CELL_W, y0 - rc.r*CELL_H, 0);

    const loader = new GLTFLoader();
    loader.load(MODEL_URL, (gltf)=>{
      const root = gltf.scene;
      root.traverse(o=>{
        if(o.isMesh){
          pickableMeshes.push(o);
          const mats = Array.isArray(o.material)? o.material : [o.material];
          for(const m of mats){ if(m){ m.side = THREE.FrontSide; } }
        }
      });
      orientFaceOn(root);
      for(const rNode of uniqueRootsUnder(root)){
        const rc = parseRC(rNode.name) || {r:0,c:0};
        const block = reparentAsBlock(rNode, puzzleRoot);
        const entry = { group:block, mesh:rNode, rc, target:targetOf(rc), placed:false, stickyTo:null };
        entries.push(entry);
        entriesByName.set(`r${rc.r}_c${rc.c}`, entry);
      }
      forcePlanarZ(puzzleRoot, 0);
      updateHUD();
      render();
    }, undefined, err=>console.error(err));

    function orientFaceOn(root){
      root.rotation.set(0,0,0);
      root.updateMatrixWorld(true);
      const bbox = new THREE.Box3().setFromObject(root);
      if(bbox.getSize(new THREE.Vector3()).z > 0.2){
        root.rotation.x = Math.PI/2;
        root.updateMatrixWorld(true);
      }
    }
    function uniqueRootsUnder(root){
      const set = new Set();
      for(const m of pickableMeshes){
        let n=m; while(n.parent && n.parent!==root) n=n.parent;
        set.add(n);
      }
      return [...set];
    }
    function parseRC(name=''){
      const m = /r(\d+)_c(\d+)/i.exec(name);
      return m? {r:+m[1], c:+m[2]} : null;
    }
    function reparentAsBlock(node, parent){
      const block = new THREE.Group();
      parent.add(block);
      node.updateMatrixWorld(true);
      const wp = new THREE.Vector3(); node.getWorldPosition(wp);
      const wq = new THREE.Quaternion(); node.getWorldQuaternion(wq);
      block.position.copy(wp); block.quaternion.copy(wq); block.scale.set(1,1,1);
      block.add(node);
      node.position.set(0,0,0); node.quaternion.identity(); node.scale.set(1,1,1);
      return block;
    }

    /* ... le reste du script est inchangé ... */
  </script>
</body>
</html>
